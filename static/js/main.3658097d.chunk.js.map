{"version":3,"sources":["pages/device-select.tsx","pages/recorder.tsx","pages/capture.tsx","App.tsx","reportWebVitals.ts","index.tsx"],"names":["DeviceList","onChangeDevice","videoinput","setVideoinput","useState","audioinput","setAudioinput","audiooutput","setAudiooutput","videoinputRef","useRef","audioinputRef","audiooutputRef","useEffect","navigator","mediaDevices","enumerateDevices","then","devices","forEach","device","kind","v","console","log","catch","err","error","changeDevice","current","selectedIndex","getSelectedDevices","title","ref","map","onChange","value","deviceId","label","Recorder","stream","recorder","chunks","videoRef","handle","start","MediaRecorder","ondataavailable","e","push","data","onstop","blobs","Blob","src","URL","createObjectURL","stop","pause","resume","delete","className","onClick","target","controls","CaptureMedia","constructor","constraints","audio","video","this","setVideoRef","getUserMedia","displayInHtml","getStream","getMedia","getDisplayMedia","srcObject","takeSnap","canvasRef","ImageCapture","getVideoTracks","grabFrame","img","canvas","ctx","getContext","width","height","widthStr","heightStr","getComputedStyle","Number","split","clearRect","drawImage","changeDevices","close","getTracks","track","removeTrack","Capture","myVideoRef","capture","setStream","async","type","startCamera","startScreen","autoPlay","App","reportWebVitals","onPerfEntry","Function","getCLS","getFID","getFCP","getLCP","getTTFB","ReactDOM","render","StrictMode","document","getElementById"],"mappings":"qQAUe,SAASA,GAAW,eACjCC,IAIA,MAAOC,EAAYC,GAAiBC,mBAA4B,KACzDC,EAAYC,GAAiBF,mBAA4B,KACzDG,EAAaC,GAAkBJ,mBAA4B,IAC5DK,EAAgBC,iBAA0B,MAC1CC,EAAgBD,iBAA0B,MAC1CE,EAAiBF,iBAA0B,MAEjDG,qBAAU,KACRC,UAAUC,aACPC,mBACAC,MAAMC,IACLA,EAAQC,SAASC,IACf,OAAQA,EAAOC,MACb,IAAK,aACHlB,GAAemB,GAAM,IAAIA,EAAGF,KAC5B,MAEF,IAAK,aACHd,GAAegB,GAAM,IAAIA,EAAGF,KAC5B,MAEF,IAAK,cACHZ,GAAgBc,GAAM,IAAIA,EAAGF,KAC7B,MAEF,QACEG,QAAQC,IAAK,kBAAiBJ,EAAOC,eAI5CI,OAAOC,IAEN,MADAH,QAAQI,MAAMD,GACRA,OAET,IACH,MAOME,EAAe,KACnB,MAAMV,EARmB,MAAyB,IAAD,YACjD,MAAO,CACLhB,WAAYA,EAAU,oBAACO,EAAcoB,eAAf,aAAC,EAAuBC,qBAAxB,QAAyC,GAC/DzB,WAAYA,EAAU,oBAACM,EAAckB,eAAf,aAAC,EAAuBC,qBAAxB,QAAyC,GAC/DvB,YAAaA,EAAW,oBAACK,EAAeiB,eAAhB,aAAC,EAAwBC,qBAAzB,QAA0C,KAIpDC,GAChB9B,EAAeiB,IAEjB,OACE,8BACG,CACC,CAAEc,MAAO,qBAAOd,QAAShB,EAAY+B,IAAKxB,GAC1C,CAAEuB,MAAO,qBAAOd,QAASb,EAAY4B,IAAKtB,IAE1CuB,KAAI,EAAGF,QAAOd,UAASe,SAErB,kCACGD,EADH,IAEE,wBAAQG,SAAUP,EAAcK,IAAKA,EAArC,SACGf,EAAQgB,KAAKd,GAEV,wBAA8BgB,MAAOhB,EAAOiB,SAA5C,SACGjB,EAAOkB,OADGlB,EAAOiB,gBALhBL,O,MCjEP,SAASO,GAAS,OAAEC,IACjC,IAAIC,EACAC,EAAiB,GACrB,MAAMC,EAAWjC,iBAAyB,MAEpCkC,EAAS,CACbC,QACEJ,EAAW,IAAIK,cAAcN,GAC7BC,EAASI,QACTJ,EAASM,gBAAmBC,GAAMN,EAAOO,KAAKD,EAAEE,MAChDT,EAASU,OAAUH,IACjB,MAAMI,EAAQ,IAAIC,KAAKX,GACnBC,EAASd,UACXc,EAASd,QAAQyB,IAAMC,IAAIC,gBAAgBJ,MAIjDK,OACEhB,EAASgB,QAEXC,QACEjB,EAASiB,SAEXC,SACElB,EAASkB,UAEXC,SACElB,EAAS,KAUb,OACE,gCACE,0BAASmB,UAAU,YAAYC,QATnC,SAAsBd,GACpB,MAAM,UAAEa,GAAcb,EAAEe,OACpBF,KAAajB,GAEfA,EAAOiB,MAKP,UACE,wBAAQA,UAAU,QAAlB,0BACA,wBAAQA,UAAU,OAAlB,0BACA,wBAAQA,UAAU,QAAlB,0BACA,wBAAQA,UAAU,SAAlB,0BACA,wBAAQA,UAAU,SAAlB,6BAEF,yBAASA,UAAU,YAAnB,SACE,uBAAO5B,IAAKU,EAAUqB,UAAQ,S,MC5CtC,MAAMC,EAYJC,YACEC,EACAxB,GACC,KAbKwB,YAAsC,CAC5CC,OAAO,EACPC,OAAO,GAWP,KARM7B,YAQN,OALMG,cAKN,EACA2B,KAAKH,YAAL,OAAmBA,QAAnB,IAAmBA,IAAeG,KAAKH,YACvCG,KAAK9B,OAAS,KACd8B,KAAK3B,SAAWA,EAGlB4B,YAAY5B,GACV2B,KAAK3B,SAAWA,EAIJ,iBACZ2B,KAAK9B,aAAe1B,UAAUC,aAC3ByD,aAAaF,KAAKH,aAClB1C,OAAOC,IAGN,MAFAH,QAAQI,MAAMD,GAERA,KAEV4C,KAAKG,gBAEPC,YACE,OAAOJ,KAAK9B,OAGG,0BAET8B,KAAKK,WAII,oBAEfL,KAAK9B,aAAe1B,UAAUC,aAE3B6D,gBAAgBN,KAAKH,aACrB1C,OAAOC,IAGN,MAFAH,QAAQI,MAAMD,GAERA,KAGV4C,KAAKG,gBAIPA,gBAAiB,IAAD,GACd,UAAIH,KAAK3B,gBAAT,aAAI,EAAed,WACjByC,KAAK3B,SAASd,QAAQgD,UAAYP,KAAK9B,QAK3CsC,SAASC,GACP,IAAKT,KAAK9B,OACR,OAEmB,IAAIwC,aAAaV,KAAK9B,OAAOyC,iBAAiB,IACtDC,YAAYjE,MAAMkE,IAC7B,MAAMC,EAASL,EAAUlD,QACzB,GAAe,OAAXuD,EAAiB,CACnB,MAAMC,EAAMD,EAAOE,WAAW,MAC9B,IAAIC,EACAC,EACJ,CACE,MAAQD,MAAOE,EAAUD,OAAQE,GAAcC,iBAC7CP,GAEFG,EAAQK,OAAOH,EAASI,MAAM,MAAM,IACpCL,EAASI,OAAOF,EAAUG,MAAM,MAAM,IAGxCR,GAAOA,EAAIS,UAAU,EAAG,EAAGP,EAAOC,GAClCH,GAAOA,EAAIU,UAAUZ,EAAK,EAAG,EAAGI,EAAOC,OAM7CQ,cAAc7B,GACZG,KAAK2B,QACL3B,KAAKH,YAAcA,EAEnBG,KAAKK,WAGPsB,QAAS,IAAD,EACN1E,QAAQC,IAAI8C,KAAK9B,QACjB,UAAA8B,KAAK9B,cAAL,SAAa0D,YAAY/E,SAASgF,IAAW,IAAD,EAC1CA,EAAM1C,OACN,UAAAa,KAAK9B,cAAL,SAAa4D,YAAYD,GACzB5E,QAAQC,IAAK,UAAS2E,EAAM9E,YAKnB,SAASgF,IACtB,MAAMC,EAAa5F,iBAAyB,MACtCqE,EAAYrE,iBAA0B,OAErC6F,GAAWnG,mBAChB,IAAI6D,EAAa,CAAEG,OAAO,EAAOC,OAAO,GAAQiC,KAG3C9D,EAAQgE,GAAapG,mBAA6BmG,EAAQ7B,aAUjE+B,eAAe9B,EAAS+B,GACtB,OAAQA,GACN,IAAK,eACGH,EAAQI,cACd,MAEF,IAAK,eACGJ,EAAQK,cAIlBJ,EAAUD,EAAQ7B,aAGpB,OACE,gCACE,cAAC,EAAD,CAAczE,eAzBG,EAAGC,aAAYG,iBAElCkB,QAAQC,IAAItB,GACZqG,EAAQP,cAAc,CACpB3B,MAAO,CAAEhC,SAAUnC,EAAWmC,UAC9B+B,MAAO,CAAE/B,SAAUhC,EAAWgC,eAqB9B,oCACE,oCACE,2DACA,uBAAOwB,UAAU,UAAUP,IAAI,IAAIuD,UAAQ,EAAC5E,IAAKqE,OAEnD,oCACE,2DACA,uBAAOzC,UAAU,aAAaP,IAAI,IAAIuD,UAAQ,OAEhD,oCACE,+CACA,wBAAQhD,UAAU,SAAS5B,IAAK8C,UAGpC,oCACE,wBAAQjB,QAAS,IAAMa,EAAS,UAAhC,sCACA,wBAAQb,QAAS,IAAMyC,EAAQzB,SAASC,GAAxC,0BACA,wBAAQjB,QAAS,IAAMa,EAAS,UAAhC,sCACA,wBAAQb,QAAS,IAAMyC,EAAQN,QAA/B,6BAGU,OAAXzD,GAAmB,cAACD,EAAD,CAAUC,OAAQA,OClK7BsE,MARf,WACE,OACE,qBAAKjD,UAAU,MAAf,SACE,cAACwC,EAAD,OCOSU,MAZUC,IACnBA,GAAeA,aAAuBC,UACxC,6BAAqBhG,MAAK,EAAGiG,SAAQC,SAAQC,SAAQC,SAAQC,cAC3DJ,EAAOF,GACPG,EAAOH,GACPI,EAAOJ,GACPK,EAAOL,GACPM,EAAQN,OCHdO,IAASC,OACP,cAAC,IAAMC,WAAP,UACE,cAAC,EAAD,MAEFC,SAASC,eAAe,SAM1BZ,M","file":"static/js/main.3658097d.chunk.js","sourcesContent":["import React, { useEffect, useRef, useState } from \"react\";\n\nimport \"./device-select.css\";\n\nexport type CurrentMediaType = {\n  videoinput: MediaDeviceInfo;\n  audioinput: MediaDeviceInfo;\n  audiooutput: MediaDeviceInfo;\n};\n\nexport default function DeviceList({\n  onChangeDevice,\n}: {\n  onChangeDevice: (currentDevics: CurrentMediaType) => void;\n}) {\n  const [videoinput, setVideoinput] = useState<MediaDeviceInfo[]>([]);\n  const [audioinput, setAudioinput] = useState<MediaDeviceInfo[]>([]);\n  const [audiooutput, setAudiooutput] = useState<MediaDeviceInfo[]>([]);\n  const videoinputRef = useRef<HTMLSelectElement>(null);\n  const audioinputRef = useRef<HTMLSelectElement>(null);\n  const audiooutputRef = useRef<HTMLSelectElement>(null);\n  // 枚举设备\n  useEffect(() => {\n    navigator.mediaDevices\n      .enumerateDevices()\n      .then((devices) => {\n        devices.forEach((device) => {\n          switch (device.kind) {\n            case \"videoinput\": {\n              setVideoinput((v) => [...v, device]);\n              break;\n            }\n            case \"audioinput\": {\n              setAudioinput((v) => [...v, device]);\n              break;\n            }\n            case \"audiooutput\": {\n              setAudiooutput((v) => [...v, device]);\n              break;\n            }\n            default:\n              console.log(`unknow device: ${device.kind}`);\n          }\n        });\n      })\n      .catch((err) => {\n        console.error(err);\n        throw err;\n      });\n  }, []);\n  const getSelectedDevices = (): CurrentMediaType => {\n    return {\n      videoinput: videoinput[videoinputRef.current?.selectedIndex ?? 0],\n      audioinput: audioinput[audioinputRef.current?.selectedIndex ?? 0],\n      audiooutput: audiooutput[audiooutputRef.current?.selectedIndex ?? 0],\n    };\n  };\n  const changeDevice = () => {\n    const devices = getSelectedDevices();\n    onChangeDevice(devices);\n  };\n  return (\n    <div>\n      {[\n        { title: \"摄像头\", devices: videoinput, ref: videoinputRef },\n        { title: \"麦克风\", devices: audioinput, ref: audioinputRef },\n        // { title: \"喇叭\", devices: audiooutput, ref: audiooutputRef },\n      ].map(({ title, devices, ref }) => {\n        return (\n          <label key={title}>\n            {title}:\n            <select onChange={changeDevice} ref={ref}>\n              {devices.map((device) => {\n                return (\n                  <option key={device.deviceId} value={device.deviceId}>\n                    {device.label}\n                  </option>\n                );\n              })}\n            </select>\n          </label>\n        );\n      })}\n    </div>\n  );\n}\n","import React, { useRef } from \"react\";\n\nimport \"./recorder.css\";\n\nexport default function Recorder({ stream }: { stream: MediaStream }) {\n  let recorder: MediaRecorder;\n  let chunks: Blob[] = [];\n  const videoRef = useRef<HTMLVideoElement>(null);\n\n  const handle = {\n    start() {\n      recorder = new MediaRecorder(stream);\n      recorder.start();\n      recorder.ondataavailable = (e) => chunks.push(e.data);\n      recorder.onstop = (e) => {\n        const blobs = new Blob(chunks);\n        if (videoRef.current) {\n          videoRef.current.src = URL.createObjectURL(blobs);\n        }\n      };\n    },\n    stop() {\n      recorder.stop();\n    },\n    pause() {\n      recorder.pause();\n    },\n    resume() {\n      recorder.resume();\n    },\n    delete() {\n      chunks = [];\n    },\n  };\n  function buttonHandle(e: React.MouseEvent<HTMLElement, MouseEvent>) {\n    const { className } = e.target as HTMLElement;\n    if (className in handle) {\n      // @ts-ignore\n      handle[className]();\n    }\n  }\n  return (\n    <div>\n      <section className=\"operation\" onClick={buttonHandle}>\n        <button className=\"start\">开始</button>\n        <button className=\"stop\">停止</button>\n        <button className=\"pause\">暂停</button>\n        <button className=\"resume\">继续</button>\n        <button className=\"delete\">删除</button>\n      </section>\n      <section className=\"playvideo\">\n        <video ref={videoRef} controls></video>\n      </section>\n    </div>\n  );\n}\n","import React, { useRef, useState } from \"react\";\n\nimport DeviceSelect, { CurrentMediaType } from \"./device-select\";\nimport Recorder from \"./recorder\";\n\nimport \"./capture.css\";\n\nclass CaptureMedia {\n  // 存放媒体约束条件\n  private constraints: MediaStreamConstraints = {\n    audio: true,\n    video: true,\n  };\n  // 存放媒体流\n  private stream: MediaStream | null;\n\n  // 视频元素,\n  private videoRef: React.RefObject<HTMLVideoElement> | undefined;\n\n  constructor(\n    constraints?: MediaStreamConstraints,\n    videoRef?: React.RefObject<HTMLVideoElement>\n  ) {\n    this.constraints = constraints ?? this.constraints;\n    this.stream = null;\n    this.videoRef = videoRef;\n  }\n\n  setVideoRef(videoRef?: React.RefObject<HTMLVideoElement>) {\n    this.videoRef = videoRef;\n  }\n\n  // 获取媒体流,并在videoRef引用元素上播放\n  async getMedia() {\n    this.stream = await navigator.mediaDevices\n      .getUserMedia(this.constraints)\n      .catch((err) => {\n        console.error(err);\n        // 将异常继续抛出\n        throw err;\n      });\n    this.displayInHtml();\n  }\n  getStream() {\n    return this.stream;\n  }\n  // 调用摄像头\n  async startCamera() {\n    //  当出现错误时 this.stream 的值是 catch 中返回的,没有显示返回则是 void\n    await this.getMedia();\n  }\n\n  // 分享屏幕\n  async startScreen() {\n    //  当出现错误时 this.stream 的值是 catch 中返回的,没有显示返回则是 void\n    this.stream = await navigator.mediaDevices\n      // @ts-ignore\n      .getDisplayMedia(this.constraints)\n      .catch((err: Error) => {\n        console.error(err);\n        // 将异常继续抛出\n        throw err;\n      });\n\n    this.displayInHtml();\n  }\n\n  // 播放媒体流\n  displayInHtml() {\n    if (this.videoRef?.current) {\n      this.videoRef.current.srcObject = this.stream;\n    }\n  }\n\n  // 截图, 将视频流的当前帧显示到canvas中\n  takeSnap(canvasRef: React.RefObject<HTMLCanvasElement>) {\n    if (!this.stream) {\n      return;\n    }\n    const imageCapture = new ImageCapture(this.stream.getVideoTracks()[0]);\n    imageCapture.grabFrame().then((img: ImageBitmap) => {\n      const canvas = canvasRef.current;\n      if (canvas !== null) {\n        const ctx = canvas.getContext(\"2d\");\n        let width;\n        let height;\n        {\n          const { width: widthStr, height: heightStr } = getComputedStyle(\n            canvas\n          );\n          width = Number(widthStr.split(\"px\")[0]);\n          height = Number(heightStr.split(\"px\")[0]);\n        }\n\n        ctx && ctx.clearRect(0, 0, width, height);\n        ctx && ctx.drawImage(img, 0, 0, width, height);\n      }\n    });\n  }\n\n  // 更改设备\n  changeDevices(constraints: MediaStreamConstraints) {\n    this.close();\n    this.constraints = constraints;\n\n    this.getMedia();\n  }\n\n  close() {\n    console.log(this.stream);\n    this.stream?.getTracks().forEach((track) => {\n      track.stop();\n      this.stream?.removeTrack(track);\n      console.log(`remove ${track.kind}`);\n    });\n  }\n}\n\nexport default function Capture() {\n  const myVideoRef = useRef<HTMLVideoElement>(null);\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n\n  const [capture] = useState<CaptureMedia>(\n    new CaptureMedia({ audio: false, video: true }, myVideoRef)\n  );\n\n  const [stream, setStream] = useState<MediaStream | null>(capture.getStream());\n  const changeDevice = ({ videoinput, audioinput }: CurrentMediaType) => {\n    // @TODO 构造 TrackConstraints 传入capture.applyConstraints\n    console.log(videoinput);\n    capture.changeDevices({\n      video: { deviceId: videoinput.deviceId },\n      audio: { deviceId: audioinput.deviceId },\n    });\n  };\n\n  async function getMedia(type: \"camera\" | \"screen\") {\n    switch (type) {\n      case \"camera\": {\n        await capture.startCamera();\n        break;\n      }\n      case \"screen\": {\n        await capture.startScreen();\n        break;\n      }\n    }\n    setStream(capture.getStream());\n  }\n\n  return (\n    <div>\n      <DeviceSelect onChangeDevice={changeDevice} />\n      <section>\n        <section>\n          <div>我的视频</div>\n          <video className=\"myvideo\" src=\"#\" autoPlay ref={myVideoRef}></video>\n        </section>\n        <section>\n          <div>对方视频</div>\n          <video className=\"othervideo\" src=\"#\" autoPlay></video>\n        </section>\n        <section>\n          <div>画布</div>\n          <canvas className=\"canvas\" ref={canvasRef}></canvas>\n        </section>\n      </section>\n      <section>\n        <button onClick={() => getMedia(\"camera\")}>捕捉媒体</button>\n        <button onClick={() => capture.takeSnap(canvasRef)}>拍照</button>\n        <button onClick={() => getMedia(\"screen\")}>分享屏幕</button>\n        <button onClick={() => capture.close()}>关闭</button>\n      </section>\n\n      {stream !== null && <Recorder stream={stream} />}\n    </div>\n  );\n}\n","import React from \"react\";\nimport \"./App.css\";\nimport Capture from \"./pages/capture\";\n\nfunction App() {\n  return (\n    <div className=\"App\">\n      <Capture />\n    </div>\n  );\n}\n\nexport default App;\n","import { ReportHandler } from 'web-vitals';\n\nconst reportWebVitals = (onPerfEntry?: ReportHandler) => {\n  if (onPerfEntry && onPerfEntry instanceof Function) {\n    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {\n      getCLS(onPerfEntry);\n      getFID(onPerfEntry);\n      getFCP(onPerfEntry);\n      getLCP(onPerfEntry);\n      getTTFB(onPerfEntry);\n    });\n  }\n};\n\nexport default reportWebVitals;\n","import React from \"react\";\nimport ReactDOM from \"react-dom\";\nimport \"./index.css\";\nimport App from \"./App\";\nimport reportWebVitals from \"./reportWebVitals\";\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById(\"root\")\n);\n\n// If you want to start measuring performance in your app, pass a function\n// to log results (for example: reportWebVitals(console.log))\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\nreportWebVitals();\n"],"sourceRoot":""}